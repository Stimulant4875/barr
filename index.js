import puppeteer from 'puppeteer';
import { JSDOM } from 'jsdom';
import axios from 'axios';

// --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±Ø§Ø³Ø±ÛŒ ---
const SPLUS_URL = "https://splus.ir/Tozie_Barq_Nikshahar_ir";
const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;
const MAX_TELEGRAM_MESSAGE_LENGTH = 4096;

// --- ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø®Ø§Ù… Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡) ---
async function getRawAnnouncementText() {
  console.log("Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ¨â€ŒÚ¯Ø±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø®Ø§Ù… Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡...");
  
  let browser;
  try {
    browser = await puppeteer.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    const page = await browser.newPage();
    
    console.log(`Ø¯Ø± Ø­Ø§Ù„ Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡: ${SPLUS_URL}`);
    await page.goto(SPLUS_URL, { waitUntil: "networkidle2", timeout: 90000 });
    
    console.log("Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...");
    await page.waitForSelector('div.channel-message-text', { timeout: 30000 });
    
    console.log("Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù†Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆØ§ÛŒ HTML...");
    const htmlContent = await page.content();
    
    const dom = new JSDOM(htmlContent);
    const messagesNodeList = dom.window.document.querySelectorAll('div.channel-message-text');

    if (messagesNodeList.length === 0) {
      return "Ø®Ø·Ø§: Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø¯Ø± ØµÙØ­Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.";
    }

    const messages = Array.from(messagesNodeList).reverse();
    let latestAnnouncementContent = "";
    let foundStartOfAnnouncement = false;
    const startPostRegex = /Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø®Ø§Ù…ÙˆØ´ÛŒ.*(\d{4}\/\d{2}\/\d{2})/;

    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ù„ÙˆÚ© Ú©Ø§Ù…Ù„ Ù…ØªÙ† Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ØŒ Ø­ØªÛŒ Ø§Ú¯Ø± Ø¯Ø± Ú†Ù†Ø¯ Ù¾Ø³Øª Ø¨Ø§Ø´Ø¯
    for (const msg of messages) {
        msg.innerHTML = msg.innerHTML.replace(/<br\s*\/?>/gi, '\n');
        const currentText = msg.textContent.trim();
        if (startPostRegex.test(currentText)) {
            // Ø§ÛŒÙ† Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù¾Ø³Øª Ø´Ø±ÙˆØ¹ Ø§Ø³Øª
            latestAnnouncementContent = currentText;
            // Ø­Ø§Ù„Ø§ Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ (Ú©Ù‡ Ø¯Ø± ÙˆØ§Ù‚Ø¹ Ø§Ø¯Ø§Ù…Ù‡ Ù‡Ù…ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ù‡Ø³ØªÙ†Ø¯) Ø±Ø§ Ø¨Ù‡ Ø¢Ù† Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            let nextMsgIndex = messages.indexOf(msg) + 1;
            while (nextMsgIndex < messages.length && !startPostRegex.test(messages[nextMsgIndex].textContent.trim())) {
                messages[nextMsgIndex].innerHTML = messages[nextMsgIndex].innerHTML.replace(/<br\s*\/?>/gi, '\n');
                latestAnnouncementContent += "\n\n" + messages[nextMsgIndex].textContent.trim();
                nextMsgIndex++;
            }
            foundStartOfAnnouncement = true;
            break; // Ú†ÙˆÙ† Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯ÛŒÙ…ØŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
        }
    }

    if (!foundStartOfAnnouncement) {
      return "Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø®Ø§Ù…ÙˆØ´ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ù…Ø±ÙˆØ² Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒØ§ÛŒ Ù†Ø¨Ø§Ø´Ø¯)";
    }
    
    // Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ùˆ Ø¯Ø³Øªâ€ŒÙ†Ø®ÙˆØ±Ø¯Ù‡
    return latestAnnouncementContent;

  } catch (error) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ¨â€ŒÚ¯Ø±Ø¯ÛŒ:", error);
    return `Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯: ${error.message}`;
  } finally {
    if (browser) await browser.close();
    console.log("ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ¨â€ŒÚ¯Ø±Ø¯ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯.");
  }
}

// --- Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª ØªÙ‚Ø³ÛŒÙ… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ) ---
async function main() {
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    console.error("Ø®Ø·Ø§: ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ÛŒØ§ Ø¢ÛŒØ¯ÛŒ Ú†Øª ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!");
    process.exit(1);
  }

  const fullMessage = await getRawAnnouncementText();
  console.log("\nâœ… --- Ù…ØªÙ† Ø®Ø§Ù… Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯ --- âœ…\n");
  
  // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†Ø§Ù¾ Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯Ø± Ù„Ø§Ú¯ØŒ ÙÙ‚Ø· Ø¨Ø®Ø´ Ú©ÙˆÚ†Ú©ÛŒ Ø§Ø² Ø¢Ù† Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
  console.log(fullMessage.substring(0, 500) + "...");
  
  // Ø¨Ø®Ø´ ØªÙ‚Ø³ÛŒÙ… Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù‚Ø·Ø¹Ø§Øª Ú©ÙˆÚ†Ú©ØªØ±
  const messageChunks = [];
  if (fullMessage.length > 0) {
      for (let i = 0; i < fullMessage.length; i += MAX_TELEGRAM_MESSAGE_LENGTH) {
        messageChunks.push(fullMessage.substring(i, i + MAX_TELEGRAM_MESSAGE_LENGTH));
      }
  } else {
      messageChunks.push("Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯.");
  }

  
  const telegramApiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  try {
    console.log(`\nğŸš€ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ${messageChunks.length} Ø¨Ø®Ø´ ØªÙ‚Ø³ÛŒÙ… Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...`);
    
    // Ø§Ø±Ø³Ø§Ù„ Ù‡Ø± Ù‚Ø·Ø¹Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
    for (const chunk of messageChunks) {
      await axios.post(telegramApiUrl, { 
        chat_id: TELEGRAM_CHAT_ID, 
        text: chunk 
      }, { timeout: 10000 });
      console.log("ÛŒÚ© Ø¨Ø®Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.");
      // ØªØ§Ø®ÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø´Øª Ø³Ø± Ù‡Ù…
      await new Promise(resolve => setTimeout(resolve, 500)); 
    }

    console.log("âœ… ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.");
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…:", error.response?.data || error.message);
    process.exit(1);
  }
}

main();
